<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Jessie Math - äº”å¹´ç´šåˆ†æ•¸å¤§æŒ‘æˆ°</title>

  <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"/>

  <style>
    :root{
      --ink:#0f172a;
      --muted:#64748b;
      --line:#e5e7eb;
      --bg:#f4f4f9;
      --card:#ffffff;

      --primary:#FFD700;
      --good:#16a34a;
      --bad:#dc2626;

      --shadow:0 10px 30px rgba(2,8,23,.08);
      --radius:18px;
      --safe:16px;

      --pill-bg:#ffffff;
      --pill-line:#dbe4ff;
      --pill-ink:#1f2937;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: Arial, "Microsoft JhengHei", system-ui, sans-serif;
      background:var(--bg);
      color:var(--ink);
    }

    /* ===================== HERO / HEADERï¼ˆå“ç‰Œä¸€è‡´ï¼‰ ===================== */
    .header{
      position:sticky;
      top:0;
      z-index:50;
      background:#fff;
      box-shadow: 0 6px 18px rgba(2,8,23,.06);
    }
    .header-inner{
      max-width: 1100px;
      margin:0 auto;
      padding: 14px 18px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:16px;
    }
    .brand-left{
      display:flex;
      align-items:center;
      gap:12px;
      min-width: 240px;
    }
    .brand-avatar{
      width:54px;
      height:54px;
      border-radius:999px;
      border:4px solid #f5a400;
      display:grid;
      place-items:center;
      overflow:hidden;
      background:transparent;
      flex:0 0 auto;
    }
    .brand-avatar img{
      width:100%;
      height:100%;
      object-fit:cover;
      background:transparent;
    }
    .brand-title{
      font-weight:900;
      font-size:32px;
      letter-spacing: .2px;
      line-height:1;
    }

    .nav-right{
      display:flex;
      align-items:center;
      gap:14px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:10px;
      padding:10px 16px;
      border-radius:999px;
      border:1px solid var(--pill-line);
      background:var(--pill-bg);
      color:var(--pill-ink);
      text-decoration:none;
      font-weight:800;
      box-shadow: 0 6px 14px rgba(2,8,23,.05);
      transition: transform .12s ease, filter .12s ease, border-color .12s ease;
      user-select:none;
      white-space:nowrap;
    }
    .pill i{ font-size:16px; opacity:.9; }
    .pill:hover{ transform: translateY(-1px); filter: brightness(.99); }
    .pill-back{
      border:2px solid #7c5cff;
      color:#4c2cff;
    }
    .pill-back i{ color:#4c2cff; }

    @media (max-width:720px){
      .brand-title{ font-size:26px; }
      .brand-left{ min-width:auto; }
      .header-inner{ padding:12px 14px; }
    }

    /* ===================== MAIN ===================== */
    .game-container{
      max-width: 860px;
      margin: 18px auto 28px;
      padding: var(--safe);
      background: var(--card);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      border:1px solid var(--line);
    }

    .screen{ display:none; padding:18px; }
    .screen.active{ display:block; }

    .center{ text-align:center; }
    h2{ margin:6px 0 10px; }
    p{ margin:10px 0; line-height:1.7; }

    .btn-primary{
      background: var(--primary);
      border:0;
      padding:10px 18px;
      margin:10px 6px;
      border-radius:14px;
      cursor:pointer;
      font-size:1rem;
      font-weight:900;
      transition: transform .12s ease, filter .12s ease;
    }
    .btn-primary:hover{ transform: translateY(-1px); filter: brightness(.98); }

    .input-like{
      width:min(340px, 92%);
      padding:12px 14px;
      border-radius:14px;
      border:1px solid var(--line);
      background:#f8fafc;
      outline:none;
      font-size:1rem;
    }
    .input-like:focus{ border-color:#cbd5e1; box-shadow:0 0 0 4px rgba(95,115,255,.18); }

    /* âœ… åˆ†æ•¸é¡¯ç¤ºï¼šåˆ†å­åœ¨ä¸Š / åˆ†æ¯åœ¨ä¸‹ */
    .frac{
      display:inline-flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      vertical-align:middle;
      line-height:1;
      font-weight:900;
      margin: 0 .08em;
      transform: translateY(-1px);
    }
    .frac .top{
      font-size:.95em;
      padding: 0 .22em .18em;
    }
    .frac .bottom{
      font-size:.95em;
      border-top:2px solid rgba(15,23,42,.45);
      padding: .18em .22em 0;
    }
    .frac.sm{ font-size:1em; }
    .frac.md{ font-size:1.05em; }
    .frac.lg{ font-size:1.1em; }
    @media (max-width:520px){
      .frac .bottom{ border-top-width:1.5px; }
    }

    /* âœ… èªªæ˜å€æ”¹å·¦å°é½Šå¡ç‰‡ */
    .rule-card{
      max-width: 720px;
      margin: 12px auto 0;
      border:1px solid var(--line);
      border-radius:16px;
      padding:14px 16px;
      background:#f8fafc;
      text-align:left;
    }
    .rule-grid{
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
      margin-top:8px;
    }
    .rule-item{
      display:flex;
      gap:10px;
      align-items:flex-start;
      padding:10px 12px;
      border:1px solid rgba(15,23,42,.06);
      border-radius:14px;
      background:#fff;
    }
    .rule-item i{
      margin-top:2px;
      width:18px;
      text-align:center;
      opacity:.9;
    }
    .rule-item .k{ font-weight:1000; }
    .tiny{ color:var(--muted); font-size:.95rem; }

    /* âœ… é—œå¡æ’ç‰ˆï¼šä¸Š3ä¸‹2ï¼ˆæ¡Œæ©Ÿ/å¹³æ¿ï¼‰ */
    .level-selection-5{
      display:grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap:14px;
      margin-top:18px;
    }
    .level-selection-5 .level-btn:nth-child(4){
      grid-column: 1 / span 2;
    }
    .level-selection-5 .level-btn:nth-child(5){
      grid-column: 3 / span 1;
    }
    @media (max-width: 620px){
      .level-selection-5{ grid-template-columns: 1fr; }
      .level-selection-5 .level-btn:nth-child(4),
      .level-selection-5 .level-btn:nth-child(5){ grid-column:auto; }
    }

    .level-btn{
      padding:18px 12px;
      border:2px solid var(--primary);
      background:#fff;
      border-radius:16px;
      font-size:1.05rem;
      cursor:pointer;
      font-weight:900;
      transition: transform .12s ease, background .12s ease;
      text-align:center;
    }
    .level-btn:hover{ transform: translateY(-2px); background:#fffbe6; }

    .game-controls{
      display:flex;
      justify-content:space-around;
      gap:10px;
      flex-wrap:wrap;
      margin-bottom:12px;
      text-align:center;
    }
    .game-stat{
      font-size:1.05rem;
      font-weight:900;
      background:#f8fafc;
      border:1px solid var(--line);
      padding:10px 12px;
      border-radius:16px;
      min-width:160px;
    }

    .question-box{
      font-size:1.8rem;
      margin:16px 0 10px;
      padding:18px;
      border:2px dashed #cbd5e1;
      border-radius:16px;
      background:#fff;
      text-align:center;
    }

    /* âœ… å°éŒ¯å›é¥‹ */
    .feedback{
      max-width: 560px;
      margin: 10px auto 2px;
      padding: 12px 14px;
      border-radius: 16px;
      border: 1px solid var(--line);
      background: #f8fafc;
      display:none;
      text-align:left;
      line-height:1.6;
    }
    .feedback.show{ display:block; }
    .feedback .tag{
      display:inline-flex;
      align-items:center;
      gap:8px;
      font-weight:1000;
      letter-spacing:.2px;
    }
    .feedback.good{ border-color: rgba(22,163,74,.35); background: rgba(22,163,74,.08); }
    .feedback.bad{ border-color: rgba(220,38,38,.35); background: rgba(220,38,38,.08); }
    .feedback .tag i{ font-size:16px; }
    .feedback .ans{ margin-top:6px; color: var(--muted); font-weight:900; }

    .answer-options{ max-width:560px; margin: 0 auto; }
    .answer-options button{
      width:100%;
      margin:8px 0;
      padding:14px;
      font-size:1.1rem;
      background:#f3f4f6;
      border:1px solid #e5e7eb;
      border-radius:14px;
      cursor:pointer;
      font-weight:900;
      transition: transform .12s ease, filter .12s ease, border-color .12s ease;
      text-align:left;
    }
    .answer-options button:hover{ transform: translateY(-1px); filter: brightness(.99); }
    .answer-options button:disabled{ opacity:.65; cursor:not-allowed; transform:none; }

    .answer-options button.correct-glow{
      border-color: rgba(22,163,74,.55);
      box-shadow: 0 0 0 4px rgba(22,163,74,.12);
      background: rgba(22,163,74,.06);
    }

    .divider{ margin:16px 0; border:0; border-top:1px solid var(--line); }

    .pause-overlay{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.72);
      color:#fff;
      display:none;
      justify-content:center;
      align-items:center;
      z-index:999;
      flex-direction:column;
      gap:10px;
      padding:20px;
      text-align:center;
    }

    table{ width:100%; border-collapse:collapse; }
    th,td{ border-bottom:1px solid var(--line); padding:10px 8px; text-align:center; }
    th{ background:#fffbe6; }
  </style>
</head>

<body>
  <!-- HERO -->
  <header class="header">
    <div class="header-inner">
      <div class="brand-left">
        <div class="brand-avatar">
          <img src="JESSIEMATH-Q.png" alt="Jessie Math" onerror="this.style.display='none'">
        </div>
        <div class="brand-title">Jessie Math</div>
      </div>

      <nav class="nav-right" aria-label="top-nav">
        <a class="pill" href="https://jessiemath0703-chu.github.io/website2/" title="é¦–é ">
          <i class="fa-solid fa-house"></i> é¦–é 
        </a>
        <a class="pill" href="https://jessiemath0703-chu.github.io/Game-Lobby/" title="éŠæˆ²å¤§å»³">
          <i class="fa-solid fa-desktop"></i> éŠæˆ²å¤§å»³
        </a>
        <!-- é€™å€‹ href å…ˆéš¨ä¾¿å¡«ï¼Œå¯¦éš›æœƒåœ¨ JS è£¡è¢« BACK_URL è“‹æ‰ -->
        <a id="backBtn" class="pill pill-back" href="#" title="äº”å¹´ç´š">
          <i class="fa-solid fa-chevron-left"></i> äº”å¹´ç´šæ“´åˆ†ç´„åˆ†èˆ‡åŠ æ¸›
        </a>
      </nav>
    </div>
  </header>

  <div class="game-container">
    <!-- Welcome -->
    <div id="welcomeScreen" class="screen active center">
      <h2>åˆ†æ•¸å¤§æŒ‘æˆ°ï¼šæ¢éšªå®¶å ±åˆ°ï¼</h2>
      <p class="tiny">åå­—è¼¸å…¥ä¸‹å»ï¼Œä½ å°±æ˜¯é€™å€‹ä¸–ç•Œçš„ä¸»è§’âœ¨</p>
      <input type="text" id="playerName" class="input-like" placeholder="æ¢éšªå®¶åå­—" autocomplete="off">
      <div>
        <button class="btn-primary" type="button" onclick="showExplanation()">é–‹å§‹éŠæˆ²</button>
      </div>
    </div>

    <!-- Explanation -->
    <div id="explanationScreen" class="screen">
      <div class="center">
        <h2>éŠæˆ²è¦å‰‡èªªæ˜ ğŸ“œ</h2>
        <p class="tiny">çœ‹æ¸…æ¥šï¼Œå°±å¯é—–é—œå•¦</p>
      </div>

      <div class="rule-card">
        <div class="rule-grid">
          <div class="rule-item">
            <i class="fa-solid fa-flag-checkered"></i>
            <div><span class="k">ä¸»é¡Œï¼š</span>äº”å¹´ç´šåˆ†æ•¸çš„æ“´åˆ†ã€ç´„åˆ†èˆ‡åŠ æ¸›</div>
          </div>
          <div class="rule-item">
            <i class="fa-solid fa-hourglass-half"></i>
            <div><span class="k">æ™‚é–“ï¼š</span>æ¯å›åˆ 60 ç§’</div>
          </div>
          <div class="rule-item">
            <i class="fa-solid fa-star"></i>
            <div><span class="k">è¨ˆåˆ†ï¼š</span>ç­”å° 100 åˆ†ï¼›é€£çºŒç­”å° Combo æœƒç–Šä¸Šå»ï¼ˆä¸Šé™ x3.0ï¼‰</div>
          </div>
          <div class="rule-item">
            <i class="fa-solid fa-bolt"></i>
            <div><span class="k">æ™‚é–“çæ‡²ï¼š</span>ç­”å° +5 ç§’ã€ç­”éŒ¯ -5 ç§’</div>
          </div>
          <div class="rule-item">
            <i class="fa-solid fa-trophy"></i>
            <div><span class="k">ç›®æ¨™ï¼š</span>æŠŠæ˜Ÿç­‰ â˜…â˜…â˜… æ‹¿åˆ°æ‰‹è»Ÿ</div>
          </div>
        </div>
      </div>

      <div class="center">
        <button class="btn-primary" type="button" onclick="showLevelSelect()">æˆ‘æ˜ç™½äº†ï¼Œé¸æ“‡é—œå¡ï¼</button>
      </div>
    </div>

    <!-- Level Select -->
    <div id="levelSelectScreen" class="screen">
      <div class="center">
        <h2>é¸æ“‡ä½ çš„æŒ‘æˆ°é—œå¡ ğŸ—ºï¸</h2>
        <p class="tiny">äº”é—œä¸€è·¯é—–ï¼šå¾æ“´åˆ†åˆ°ç¶œåˆï¼ŒæŠŠåˆ†æ•¸ç·´åˆ°åˆå¿«åˆç©©ã€‚</p>
      </div>

      <div class="level-selection-5">
        <button class="level-btn" type="button" onclick="showDifficultySelect(1)">ç¬¬ 1 é—œï¼šåˆ†æ•¸æ“´åˆ†</button>
        <button class="level-btn" type="button" onclick="showDifficultySelect(2)">ç¬¬ 2 é—œï¼šåˆ†æ•¸ç´„åˆ†</button>
        <button class="level-btn" type="button" onclick="showDifficultySelect(3)">ç¬¬ 3 é—œï¼šåŒåˆ†æ¯åŠ æ¸›</button>
        <button class="level-btn" type="button" onclick="showDifficultySelect(4)">ç¬¬ 4 é—œï¼šç•°åˆ†æ¯åŠ æ¸›</button>
        <button class="level-btn" type="button" onclick="showDifficultySelect(5)">ç¬¬ 5 é—œï¼šç¶œåˆæŒ‘æˆ°</button>
      </div>

      <div class="center">
        <button class="btn-primary" type="button" style="margin-top:18px;" onclick="showRanking()">ğŸ† æ’è¡Œæ¦œ</button>
      </div>
    </div>

    <!-- Difficulty -->
    <div id="difficultySelectScreen" class="screen center">
      <h2 id="currentLevelTitle"></h2>
      <p class="tiny">é¸é›£åº¦åƒé¸ç¯€å¥ï¼šæ…¢æ˜¯å„ªé›…ï¼Œå¿«æ˜¯ç‡ƒ ğŸ”¥</p>
      <button class="btn-primary" type="button" onclick="startGame('easy')">ç°¡å–®ï¼ˆè¼ƒæ…¢ï¼‰</button>
      <button class="btn-primary" type="button" onclick="startGame('normal')">æ™®é€šï¼ˆæ¨™æº–ï¼‰</button>
      <button class="btn-primary" type="button" onclick="startGame('hard')">å›°é›£ï¼ˆè¶…å¿«ï¼‰</button>
      <div>
        <button class="btn-primary" type="button" onclick="showLevelSelect()">è¿”å›</button>
      </div>
    </div>

    <!-- Game -->
    <div id="gameScreen" class="screen">
      <div class="game-controls">
        <span class="game-stat">æ™‚é–“ï¼š<span id="timer">60</span>s</span>
        <span class="game-stat">åˆ†æ•¸ï¼š<span id="score">0</span></span>
        <span class="game-stat">Comboï¼šx<span id="combo">1.0</span></span>
      </div>

      <div class="question-box">
        <div id="questionText">æº–å‚™å‡ºé¡Œä¸­â€¦</div>
      </div>

      <div id="feedbackBox" class="feedback">
        <div class="tag" id="feedbackTag"></div>
        <div class="ans" id="feedbackAns"></div>
      </div>

      <div class="answer-options">
        <button id="optionA" type="button" onclick="checkAnswer('A')">A</button>
        <button id="optionB" type="button" onclick="checkAnswer('B')">B</button>
        <button id="optionC" type="button" onclick="checkAnswer('C')">C</button>
      </div>

      <hr class="divider">

      <div class="center">
        <button class="btn-primary" type="button" onclick="pauseGame()"><i class="fa-solid fa-pause"></i> æš«åœ</button>
        <button class="btn-primary" type="button" onclick="restartGame()"><i class="fa-solid fa-rotate-right"></i> é‡æ–°é–‹å§‹</button>
        <button class="btn-primary" type="button" onclick="quitGame()"><i class="fa-solid fa-right-from-bracket"></i> å›é—œå¡ä¸»é¸å–®</button>
      </div>
    </div>

    <!-- Ranking -->
    <div id="rankingScreen" class="screen">
      <div class="center">
        <h2>ğŸ† å…¨çƒæ¢éšªå®¶æ’è¡Œæ¦œ</h2>
      </div>
      <table>
        <thead>
          <tr><th>åæ¬¡</th><th>æ¢éšªå®¶</th><th>åˆ†æ•¸</th><th>æ˜Ÿç­‰</th></tr>
        </thead>
        <tbody id="rankingTableBody">
          <tr><td>1</td><td>Jessie</td><td>1500</td><td>â˜…â˜…â˜…</td></tr>
        </tbody>
      </table>
      <div class="center">
        <button class="btn-primary" type="button" onclick="showLevelSelect()">è¿”å›é—œå¡é¸æ“‡</button>
      </div>
    </div>

    <!-- Pause Overlay -->
    <div id="pauseOverlay" class="pause-overlay" role="dialog" aria-modal="true">
      <h1>éŠæˆ²å·²æš«åœ</h1>
      <button class="btn-primary" type="button" onclick="resumeGame()"><i class="fa-solid fa-play"></i> ç¹¼çºŒéŠæˆ²</button>
    </div>
  </div>

  <script>
    /* ========== å¹¾å¹´ç´šä¸»é¡Œï¼ˆå¯æ”¹ï¼‰ ========== */
    const BACK_GRADE = "äº”å¹´ç´š";
    const BACK_TOPIC  = "æ“´åˆ†ç´„åˆ†èˆ‡åŠ æ¸›";
    /* ğŸ” é€™è£¡ç›´æ¥å¸¶éŒ¨é» #g5-u7 */
    const BACK_URL = "https://jessiemath0703-chu.github.io/Game-Lobby/#g5-u7";

    /* ========== GAME STATE ========== */
    let currentPlayerName = "";
    let currentLevel = 0;
    let currentDifficulty = "";
    let timerInterval = null;
    let gameTime = 60;
    let currentScore = 0;
    let comboMultiplier = 1.0;
    let isPaused = false;

    const levelNames = ["", "åˆ†æ•¸æ“´åˆ†", "åˆ†æ•¸ç´„åˆ†", "åŒåˆ†æ¯åŠ æ¸›", "ç•°åˆ†æ¯åŠ æ¸›", "ç¶œåˆæŒ‘æˆ°"];

    const feedbackBox = () => document.getElementById("feedbackBox");
    const feedbackTag = () => document.getElementById("feedbackTag");
    const feedbackAns = () => document.getElementById("feedbackAns");

    function showScreen(screenId){
      document.querySelectorAll(".screen").forEach(s => s.classList.remove("active"));
      const el = document.getElementById(screenId);
      if (el) el.classList.add("active");
    }

    function showExplanation(){
      const nameInput = document.getElementById("playerName").value.trim();
      if(!nameInput) return alert("è«‹è¼¸å…¥æ‚¨çš„åå­—ï¼");
      currentPlayerName = nameInput;
      showScreen("explanationScreen");
    }
    function showLevelSelect(){ showScreen("levelSelectScreen"); }

    function showDifficultySelect(level){
      currentLevel = level;
      document.getElementById("currentLevelTitle").textContent = `ç¬¬ ${level} é—œï¼š${levelNames[level]}`;
      showScreen("difficultySelectScreen");
    }

    function updateStats(){
      document.getElementById("timer").textContent = gameTime;
      document.getElementById("score").textContent = currentScore;
      document.getElementById("combo").textContent = comboMultiplier.toFixed(1);
    }

    function startTimer(){
      clearInterval(timerInterval);
      timerInterval = setInterval(() => {
        if(isPaused) return;
        gameTime--;
        if(gameTime <= 0){
          gameTime = 0;
          updateStats();
          endGame();
          return;
        }
        updateStats();
      }, 1000);
    }

    /* âœ… åˆ†æ•¸ HTMLï¼šåˆ†å­åœ¨ä¸Š / åˆ†æ¯åœ¨ä¸‹ */
    function fracHTML(n,d,size="md"){
      return `<span class="frac ${size}" aria-label="${n} åˆ†ä¹‹ ${d}"><span class="top">${n}</span><span class="bottom">${d}</span></span>`;
    }
    function fracKey(n,d){ return `${n}/${d}`; }

    /* ========== å°å·¥å…·ï¼šæœ€å¤§å…¬å› æ•¸ / æœ€å°å…¬å€æ•¸ / ç´„åˆ† ========== */
    function gcd(a,b){
      a = Math.abs(a); b = Math.abs(b);
      while(b){ [a,b] = [b, a%b]; }
      return a || 1;
    }
    function lcm(a,b){
      return Math.abs(a*b) / gcd(a,b);
    }
    function reduceFrac(n,d){
      const g = gcd(n,d);
      return { n: n/g, d: d/g };
    }

    /* ========== é¡Œç›®ç”Ÿæˆï¼ˆæ¯é—œéƒ½å‹•æ…‹è®ŠåŒ–ï¼‰ ========== */
    let correctKey = "A";
    let correctFrac = {n:1,d:2};  // âœ… æ­£ç¢ºç­”æ¡ˆç”¨ç‰©ä»¶å­˜
    let currentQuestionHTML = "";

    function randInt(min, max){
      return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    function uniqueByKey(fracs){
      const seen = new Set();
      const out = [];
      for(const f of fracs){
        const k = fracKey(f.n,f.d);
        if(!seen.has(k)){
          seen.add(k);
          out.push(f);
        }
      }
      return out;
    }

    function shuffle(arr){
      for(let i = arr.length - 1; i > 0; i--){
        const j = Math.floor(Math.random()*(i+1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }

    function makeDistractors(cn, cd){
      const list = [];
      list.push(reduceFrac(Math.max(1, cn-1), cd));
      list.push(reduceFrac(cn+1, cd));
      list.push(reduceFrac(cn, Math.max(2, cd-1)));
      list.push(reduceFrac(cn, cd+1));
      const k = randInt(2,4);
      list.push({ n: cn*k, d: cd*k }); // æœªç´„åˆ†å‹å¹²æ“¾
      return list;
    }

    function clearOptionGlow(){
      ["A","B","C"].forEach(k => document.getElementById("option"+k).classList.remove("correct-glow"));
    }
    function setOptionsDisabled(disabled){
      ["A","B","C"].forEach(k => document.getElementById("option"+k).disabled = disabled);
    }

    function showFeedback(isCorrect){
      const box = feedbackBox();
      box.classList.remove("good","bad");
      box.classList.add("show", isCorrect ? "good" : "bad");

      if(isCorrect){
        feedbackTag().innerHTML = `<i class="fa-solid fa-circle-check"></i> ç­”å°ï¼ä½ çš„è…¦è¢‹åœ¨ç™¼å…‰`;
        feedbackAns().innerHTML = "";
      }else{
        feedbackTag().innerHTML = `<i class="fa-solid fa-circle-xmark"></i> ç­”éŒ¯äº†ï¼Œä½†ç­”æ¡ˆæˆ‘å¹«ä½ æŠ“å›ä¾†äº†`;
        feedbackAns().innerHTML = `æ­£ç¢ºç­”æ¡ˆï¼š${correctKey}ï¼ˆ${fracHTML(correctFrac.n, correctFrac.d, "sm")}ï¼‰`;
      }
    }

    function hideFeedback(){
      feedbackBox().classList.remove("show","good","bad");
      feedbackTag().textContent = "";
      feedbackAns().textContent = "";
    }

    function buildOptions(correct){
      // correct: {n,d}
      const correctReduced = reduceFrac(correct.n, correct.d);
      const correctK = fracKey(correctReduced.n, correctReduced.d);

      let distract = makeDistractors(correctReduced.n, correctReduced.d)
        .map(x => reduceFrac(x.n, x.d));

      // é¡å¤–å¹²æ“¾ï¼šåˆ†æ¯ +1~3ã€åˆ†å­ -1~2
      distract.push(reduceFrac(correctReduced.n, correctReduced.d + randInt(1,3)));
      distract.push(reduceFrac(Math.max(1, correctReduced.n - randInt(1,2)), correctReduced.d));

      distract = uniqueByKey(distract).filter(f => fracKey(f.n,f.d) !== correctK);

      const picks = shuffle([correctReduced, distract[0], distract[1]]);

      const keys = ["A","B","C"];
      const map = {};
      picks.forEach((f,i) => map[keys[i]] = f);

      correctKey = keys[picks.findIndex(f => fracKey(f.n,f.d) === correctK)];
      correctFrac = correctReduced;

      return map;
    }

    /* ====== å„é—œé¡Œå‹ï¼ˆæ”¹æˆè¼¸å‡º HTML å•é¡Œï¼‰ ====== */
    function genLevel1(){
      let b = randInt(2,9);
      let a = randInt(1,b-1);
      const r = reduceFrac(a,b); a=r.n; b=r.d;

      const m = randInt(2,6);
      const targetD = b*m;
      const targetN = a*m;

      currentQuestionHTML = `æŠŠ ${fracHTML(a,b,"lg")} æ“´åˆ†æˆåˆ†æ¯ <strong>${targetD}</strong> çš„ç­‰å€¼åˆ†æ•¸æ˜¯ï¼Ÿ`;
      return buildOptions({ n: targetN, d: targetD });
    }

    function genLevel2(){
      let q = randInt(2,12);
      let p = randInt(1,q-1);
      let r = reduceFrac(p,q); p=r.n; q=r.d;

      const k = randInt(2,8);
      const nn = p*k, dd = q*k;

      currentQuestionHTML = `æŠŠ ${fracHTML(nn,dd,"lg")} ç´„åˆ†å¾Œæ˜¯ï¼Ÿ`;
      return buildOptions({ n: p, d: q });
    }

    function genLevel3(){
      const d = randInt(4,15);
      let a = randInt(1,d-1);
      let b = randInt(1,d-1);
      const isAdd = Math.random() < 0.55;

      let n;
      if(isAdd){
        n = a + b;
        if(n > d*2){ b = randInt(1, Math.max(1, d-1-a)); n = a + b; }
        currentQuestionHTML = `åŒåˆ†æ¯ï¼š${fracHTML(a,d,"lg")} + ${fracHTML(b,d,"lg")} = ?`;
      }else{
        if(a < b) [a,b] = [b,a];
        n = a - b;
        currentQuestionHTML = `åŒåˆ†æ¯ï¼š${fracHTML(a,d,"lg")} âˆ’ ${fracHTML(b,d,"lg")} = ?`;
      }

      const reduced = reduceFrac(n,d);
      return buildOptions(reduced);
    }

    function genLevel4(){
      let d1 = randInt(4,12);
      let d2 = randInt(4,12);
      while(d2 === d1) d2 = randInt(4,12);

      let n1 = randInt(1,d1-1);
      let n2 = randInt(1,d2-1);

      const isAdd = Math.random() < 0.6;
      const L = lcm(d1,d2);

      const A = n1 * (L/d1);
      const B = n2 * (L/d2);

      if(isAdd){
        const num = A + B;
        currentQuestionHTML = `ç•°åˆ†æ¯ï¼š${fracHTML(n1,d1,"lg")} + ${fracHTML(n2,d2,"lg")} = ?`;
        return buildOptions(reduceFrac(num, L));
      }else{
        // é¿å…è² æ•¸ï¼šå¿…è¦æ™‚äº¤æ›
        if(A < B){
          [n1,n2] = [n2,n1];
          [d1,d2] = [d2,d1];
          const L2 = lcm(d1,d2);
          const A2 = n1 * (L2/d1);
          const B2 = n2 * (L2/d2);
          const num2 = A2 - B2;
          currentQuestionHTML = `ç•°åˆ†æ¯ï¼š${fracHTML(n1,d1,"lg")} âˆ’ ${fracHTML(n2,d2,"lg")} = ?`;
          return buildOptions(reduceFrac(num2, L2));
        }
        const num = A - B;
        currentQuestionHTML = `ç•°åˆ†æ¯ï¼š${fracHTML(n1,d1,"lg")} âˆ’ ${fracHTML(n2,d2,"lg")} = ?`;
        return buildOptions(reduceFrac(num, L));
      }
    }

    function genLevel5(){
      const pick = randInt(1,4);
      if(pick===1) return genLevel1();
      if(pick===2) return genLevel2();
      if(pick===3) return genLevel3();
      return genLevel4();
    }

    function nextQuestion(){
      clearOptionGlow();
      setOptionsDisabled(false);
      hideFeedback();

      let optionsMap;
      if(currentLevel === 1) optionsMap = genLevel1();
      else if(currentLevel === 2) optionsMap = genLevel2();
      else if(currentLevel === 3) optionsMap = genLevel3();
      else if(currentLevel === 4) optionsMap = genLevel4();
      else optionsMap = genLevel5();

      // âœ… é¡Œç›®æ”¹ç”¨ innerHTMLï¼ˆæ‰èƒ½é¡¯ç¤ºå †ç–Šåˆ†æ•¸ï¼‰
      document.getElementById("questionText").innerHTML = currentQuestionHTML;

      // âœ… é¸é …ä¹Ÿæ”¹ç”¨ innerHTML
      document.getElementById("optionA").innerHTML = `A. ${fracHTML(optionsMap.A.n, optionsMap.A.d, "md")}`;
      document.getElementById("optionB").innerHTML = `B. ${fracHTML(optionsMap.B.n, optionsMap.B.d, "md")}`;
      document.getElementById("optionC").innerHTML = `C. ${fracHTML(optionsMap.C.n, optionsMap.C.d, "md")}`;
    }

    function startGame(difficulty){
      currentDifficulty = difficulty;
      isPaused = false;
      gameTime = 60;
      currentScore = 0;
      comboMultiplier = 1.0;

      updateStats();
      showScreen("gameScreen");

      nextQuestion();
      startTimer();
    }

    function difficultySpeed(){
      if(currentDifficulty === "easy") return 1200;
      if(currentDifficulty === "hard") return 650;
      return 900;
    }

    function checkAnswer(selected){
      if(isPaused || gameTime <= 0) return;

      setOptionsDisabled(true);
      clearOptionGlow();

      const isCorrect = (selected === correctKey);

      if(isCorrect){
        currentScore += Math.floor(100 * comboMultiplier);
        comboMultiplier = Math.min(3.0, comboMultiplier + 0.5);
        gameTime += 5;
      }else{
        comboMultiplier = 1.0;
        gameTime = Math.max(0, gameTime - 5);
        document.getElementById("option"+correctKey).classList.add("correct-glow");
      }

      updateStats();
      showFeedback(isCorrect);

      if(gameTime <= 0) return endGame();

      setTimeout(() => {
        if(!isPaused && gameTime > 0){
          nextQuestion();
        }
      }, difficultySpeed());
    }

    function pauseGame(){
      isPaused = true;
      document.getElementById("pauseOverlay").style.display = "flex";
    }
    function resumeGame(){
      isPaused = false;
      document.getElementById("pauseOverlay").style.display = "none";
    }

    function restartGame(){
      clearInterval(timerInterval);
      if(confirm("ç¢ºå®šè¦é‡æ–°é–‹å§‹æœ¬å±€éŠæˆ²å—ï¼Ÿåˆ†æ•¸å’Œæ™‚é–“å°‡æ­¸é›¶ã€‚")){
        startGame(currentDifficulty || "normal");
      }else{
        startTimer();
      }
    }

    function quitGame(){
      clearInterval(timerInterval);
      if(confirm("ç¢ºå®šè¦çµæŸæœ¬å±€éŠæˆ²ä¸¦è¿”å›é—œå¡é¸å–®å—ï¼Ÿæœ¬å±€æˆç¸¾ä¸æœƒå¯«å…¥æ’è¡Œæ¦œã€‚")){
        showLevelSelect();
      }else{
        startTimer();
      }
    }

    function endGame(){
      clearInterval(timerInterval);
      alert(`éŠæˆ²çµæŸï¼${currentPlayerName}ï¼Œä½ ç²å¾—äº† ${currentScore} åˆ†ï¼`);
      showLevelSelect();
    }

    function showRanking(){ showScreen("rankingScreen"); }

    document.addEventListener("DOMContentLoaded", () => {
      const backBtn = document.getElementById("backBtn");
      if(backBtn){
        backBtn.href = BACK_URL;
        backBtn.innerHTML = `<i class="fa-solid fa-chevron-left"></i> å›åˆ°${BACK_GRADE}${BACK_TOPIC}`;
      }
      showScreen("welcomeScreen");
    });
  </script>
</body>
</html>
